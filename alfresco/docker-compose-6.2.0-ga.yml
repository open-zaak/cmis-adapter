# Using version 2 as 3 does not support resource constraint options (cpu_*, mem_* limits) for non swarm mode in Compose
version: "2"

services:
    alfresco:
        image: alfresco/alfresco-content-repository-community:6.2.0-ga
        mem_limit: 3g
        depends_on: 
            - postgres  
        environment:
            JAVA_OPTS : "
                -Ddb.driver=org.postgresql.Driver
                -Ddb.username=alfresco
                -Ddb.password=alfresco
                -Ddb.url=jdbc:postgresql://postgres:5432/alfresco  
                -Dsolr.host=solr6
                -Dsolr.port=8983
                -Dsolr.secureComms=none
                -Dsolr.baseUrl=/solr
                -Dindex.subsystem.name=solr6
                -Dalfresco.host=localhost
                -Dalfresco.port=8082
                
                -Dshare.host=localhost
                -Dshare.port=8082
                
                -Daos.baseUrlOverwrite=http://localhost:8082/alfresco/aos
                -Dmessaging.broker.url=\"failover:(nio://activemq:61616)?timeout=3000&jms.useCompression=true\"
                -Ddeployment.method=DOCKER_COMPOSE
                -Dcsrf.filter.enabled=false 
                -Xms2g -Xmx2g   
            "
        volumes: 
            - ./volumes/data/alf-repo-data:/usr/local/tomcat/alf_data
            - ./volumes/logs/alfresco:/usr/local/tomcat/logs   
            - ./extension:/usr/local/tomcat/shared/classes/alfresco/extension
            - ./config/alfresco-global.properties:/usr/local/tomcat/shared/classes/alfresco-global.properties
        ports:
            - 8082:8080 #Browser port        
    share:
        image: alfresco/alfresco-share:6.2.0
        mem_limit: 1g
        environment:
            REPO_HOST: "alfresco"
            REPO_PORT: "8080"
            CSRF_FILTER_REFERER: "http://localhost/.*"
            CSRF_FILTER_ORIGIN: "http://localhost"
            JAVA_OPTS: "
                -Xms976m -Xmx976m
                -Dalfresco.context=alfresco
                -Dalfresco.protocol=http
                "
        volumes: 
            - ./volumes/logs/share:/usr/local/tomcat/logs  
        ports:
            - 8080:8080
    
    postgres:
        image: postgres:11.4
        mem_limit: 1104m
        environment:
            - POSTGRES_PASSWORD=alfresco
            - POSTGRES_USER=alfresco
            - POSTGRES_DB=alfresco
        command: "
            postgres
              -c max_connections=200
              -c log_min_messages=LOG"
        volumes: 
            - ./volumes/data/postgres-data:/var/lib/postgresql/data
        #    - ./volumes/logs/postgres:/var/log/postgresql  
        ports:
            - 5434:5432
     
    solr6:
        image: alfresco/alfresco-search-services:2.0.1
        mem_limit: 2208m
        environment:
            #Solr needs to know how to register itself with Alfresco
            SOLR_ALFRESCO_HOST: "alfresco"
            SOLR_ALFRESCO_PORT: "8080"
            #Alfresco needs to know how to call solr
            SOLR_SOLR_HOST: "solr6"
            SOLR_SOLR_PORT: "8983"
            #Create the default alfresco and archive cores
            SOLR_CREATE_ALFRESCO_DEFAULTS: "alfresco,archive"
            SOLR_JAVA_MEM: "-Xms1952m -Xmx1952m"
            SOLR_OPTS: "
                -XX:NewSize=848m
                -XX:MaxNewSize=848m
            "
        # volumes: 
        #     - ./data/solr-data:/opt/alfresco-search-services/data
        ports:
            - 8083:8983 #Browser port

    activemq:
        image: alfresco/alfresco-activemq:5.15.8
        mem_limit: 1g
        ports:
            - 8161:8161 # Web Console
            - 5673:5672 # AMQP
            - 61616:61616 # OpenWire
            - 61613:61613 # STOMP
